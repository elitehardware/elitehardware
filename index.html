<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RedSec LFG - Find Squad Fast</title>
  <link href="https://unpkg.com/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: #0f172a; color: #e2e8f0; font-family: system-ui; }
    .card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgb(239 68 68 / 0.3); }
    .toast { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      padding: 16px 24px; 
      background: #10b981; 
      color: white; 
      border-radius: 8px; 
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .pulse-dot {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .skeleton {
      background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
      background-size: 200% 100%;
      animation: loading 1.5s ease-in-out infinite;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .time-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      opacity: 0.8;
    }
    .setup-banner {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
    }
  </style>
</head>
<body class="min-h-screen py-8 px-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl md:text-5xl font-bold text-center mb-2 text-red-500">RedSec LFG</h1>
    <p class="text-center text-lg mb-8">Find a squad in seconds ‚Ä¢ No Discord required</p>

    <!-- Setup Instructions Banner -->
    <div class="setup-banner" id="setupBanner">
      <h2 class="text-2xl font-bold mb-3">üîß Quick Setup Required</h2>
      <p class="mb-4">To enable real-time cross-user sharing, follow these 3 simple steps:</p>
      <ol class="list-decimal list-inside space-y-2 mb-4 bg-black/20 p-4 rounded-lg">
        <li><strong>Go to <a href="https://console.firebase.google.com/" target="_blank" class="underline">Firebase Console</a></strong> (free, no credit card needed)</li>
        <li><strong>Create a new project</strong> ‚Üí Enable "Realtime Database" ‚Üí Start in test mode</li>
        <li><strong>Copy your config</strong> from Project Settings ‚Üí General ‚Üí Web App, then paste below:</li>
      </ol>
      
      <div class="bg-slate-900 rounded-lg p-4 mb-4">
        <label class="block text-sm font-bold mb-2">Paste Firebase Config JSON:</label>
        <textarea 
          id="firebaseConfig" 
          class="w-full bg-slate-800 text-white p-3 rounded font-mono text-xs h-32 focus:ring-2 focus:ring-red-500 outline-none"
          placeholder='{
  "apiKey": "AIza...",
  "authDomain": "...",
  "databaseURL": "https://...",
  "projectId": "...",
  "storageBucket": "...",
  "messagingSenderId": "...",
  "appId": "..."
}'></textarea>
      </div>
      
      <button id="saveConfigBtn" class="w-full bg-white text-red-600 font-bold py-3 rounded-lg hover:bg-gray-100 transition-all">
        ‚úÖ Save Config & Start Using
      </button>
      
      <p class="text-xs mt-3 text-white/70">üí° Config is saved locally in your browser. Set this up once per device.</p>
    </div>

    <!-- Main App (hidden until configured) -->
    <div id="mainApp" style="display: none;">
      <!-- Post Form -->
      <div class="bg-slate-800 rounded-xl p-6 mb-10 shadow-xl">
        <h2 class="text-2xl font-bold mb-4">Post LFG</h2>
        <form id="lfgForm" class="grid md:grid-cols-3 gap-4">
          <input 
            required 
            placeholder="Username / Gamertag" 
            class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" 
            id="name"
            maxlength="30"
            autocomplete="off"
          />
          <input 
            required 
            placeholder="Discord link or tag" 
            class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" 
            id="discord"
            autocomplete="off"
          />
          <select required class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" id="platform">
            <option value="" disabled selected>Platform</option>
            <option>PC</option><option>PlayStation</option><option>Xbox</option><option>Mobile</option><option>Cross-Platform</option>
          </select>
          <select required class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" id="region">
            <option value="" disabled selected>Region</option>
            <option>NA East</option><option>NA West</option><option>EU</option><option>Asia</option><option>OCE</option><option>SA</option>
          </select>
          <select required class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" id="mic">
            <option value="" disabled selected>Mic?</option>
            <option>Yes</option><option>No</option><option>Optional</option>
          </select>
          <input 
            placeholder="Note (optional)" 
            class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" 
            id="note"
            maxlength="50"
            autocomplete="off"
          />
          <button type="submit" id="submitBtn" class="md:col-span-3 bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg text-xl transition-all">
            üöÄ POST LFG (expires in 2 hours)
          </button>
        </form>
      </div>

      <!-- Filters -->
      <div class="flex flex-wrap gap-3 mb-8 justify-center">
        <input id="search" placeholder="üîç Search anything‚Ä¶" class="px-4 py-2 bg-slate-800 rounded-lg flex-1 min-w-[200px] focus:ring-2 focus:ring-red-500 outline-none"/>
        <select id="filterPlatform" class="px-4 py-2 bg-slate-800 rounded-lg focus:ring-2 focus:ring-red-500 outline-none">
          <option value="">All Platforms</option>
          <option>PC</option><option>PlayStation</option><option>Xbox</option><option>Mobile</option><option>Cross-Platform</option>
        </select>
        <select id="filterRegion" class="px-4 py-2 bg-slate-800 rounded-lg focus:ring-2 focus:ring-red-500 outline-none">
          <option value="">All Regions</option>
          <option>NA East</option><option>NA West</option><option>EU</option><option>Asia</option><option>OCE</option><option>SA</option>
        </select>
        <button onclick="location.reload()" class="px-6 py-2 bg-slate-700 rounded-lg hover:bg-slate-600 transition-all">Clear</button>
      </div>

      <!-- Live Listings -->
      <div id="listings" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="skeleton rounded-xl h-64"></div>
        <div class="skeleton rounded-xl h-64"></div>
        <div class="skeleton rounded-xl h-64"></div>
      </div>
      <p class="text-center mt-10 text-gray-500 flex items-center justify-center gap-2" id="count">
        <span class="pulse-dot inline-block w-2 h-2 bg-green-500 rounded-full"></span>
        0 players looking right now
      </p>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getDatabase, ref, push, onValue, remove, query, orderByChild } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  let db, postsRef;
  const RATE_LIMIT_KEY = 'redsec_last_post';
  const RATE_LIMIT_MS = 30000;
  const CONFIG_KEY = 'firebase_config';

  // Check if already configured
  const savedConfig = localStorage.getItem(CONFIG_KEY);
  if (savedConfig) {
    try {
      const config = JSON.parse(savedConfig);
      initFirebase(config);
    } catch (err) {
      console.error("Invalid saved config:", err);
    }
  }

  // Attach save button event listener
  document.getElementById('saveConfigBtn').addEventListener('click', function() {
    const configText = document.getElementById('firebaseConfig').value.trim();
    try {
      const config = JSON.parse(configText);
      if (!config.apiKey || !config.databaseURL) {
        showToast("Invalid config - missing required fields", "error");
        return;
      }
      localStorage.setItem(CONFIG_KEY, configText);
      initFirebase(config);
      document.getElementById('setupBanner').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      showToast("‚úÖ Firebase connected successfully!");
    } catch (err) {
      showToast("Invalid JSON format. Please check your config.", "error");
    }
  });

  function initFirebase(config) {
    try {
      const app = initializeApp(config);
      db = getDatabase(app);
      postsRef = ref(db, 'lfg-posts');
      
      document.getElementById('setupBanner').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      
      // Listen for real-time updates
      onValue(postsRef, (snapshot) => {
        renderPosts(snapshot.val());
      });
      
      // Clean expired posts every minute
      setInterval(cleanExpiredPosts, 60000);
    } catch (err) {
      console.error("Firebase init failed:", err);
      showToast("Failed to connect to Firebase. Check your config.", "error");
    }
  }

  function showToast(message, type = 'success') {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.style.background = type === 'error' ? '#ef4444' : '#10b981';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function sanitize(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function validateDiscord(input) {
    const discordLinkPattern = /discord\.(gg|com\/invite)\//i;
    const discordTagPattern = /^.{2,32}#\d{4}$|^@?[a-z0-9_.]{2,32}$/i;
    return discordLinkPattern.test(input) || discordTagPattern.test(input);
  }

  function canPost() {
    const lastPost = localStorage.getItem(RATE_LIMIT_KEY);
    if (lastPost) {
      const timeSince = Date.now() - parseInt(lastPost);
      if (timeSince < RATE_LIMIT_MS) {
        const remaining = Math.ceil((RATE_LIMIT_MS - timeSince) / 1000);
        showToast(`Please wait ${remaining}s before posting again`, 'error');
        return false;
      }
    }
    return true;
  }

  function timeAgo(timestamp) {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return 'Just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    return `${hours}h ago`;
  }

  document.getElementById("lfgForm").onsubmit = async (e) => {
    e.preventDefault();
    
    if (!db) {
      showToast("Please configure Firebase first", 'error');
      return;
    }

    if (!canPost()) return;

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Posting...';

    const discordInput = e.target.discord.value.trim();
    
    if (!validateDiscord(discordInput)) {
      showToast("Please enter a valid Discord link or tag", 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'üöÄ POST LFG (expires in 2 hours)';
      return;
    }

    try {
      const data = {
        name: sanitize(e.target.name.value.trim()),
        discord: sanitize(discordInput),
        platform: e.target.platform.value,
        region: e.target.region.value,
        mic: e.target.mic.value,
        note: sanitize(e.target.note.value.trim() || ''),
        time: Date.now(),
        expires: Date.now() + 2*60*60*1000
      };
      
      await push(postsRef, data);
      localStorage.setItem(RATE_LIMIT_KEY, Date.now().toString());
      e.target.reset();
      showToast("‚úÖ Posted! Your LFG is now live!");
    } catch (err) {
      console.error("Post failed:", err);
      showToast("Failed to post. Please try again.", 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'üöÄ POST LFG (expires in 2 hours)';
    }
  };

  async function cleanExpiredPosts() {
    if (!db) return;
    
    const snapshot = await onValue(postsRef, (snap) => {
      const posts = snap.val();
      if (!posts) return;
      
      Object.entries(posts).forEach(([key, post]) => {
        if (post.expires < Date.now()) {
          remove(ref(db, `lfg-posts/${key}`));
        }
      });
    }, { onlyOnce: true });
  }

  function renderPosts(postsData) {
    let posts = [];
    
    if (postsData) {
      posts = Object.entries(postsData)
        .map(([key, post]) => ({ ...post, id: key }))
        .filter(p => p.expires > Date.now() && p.name && p.discord);
    }

    const search = document.getElementById("search").value.toLowerCase();
    const filterPlatform = document.getElementById("filterPlatform").value;
    const filterRegion = document.getElementById("filterRegion").value;

    if (search) {
      posts = posts.filter(p => 
        p.name.toLowerCase().includes(search) ||
        p.discord.toLowerCase().includes(search) ||
        p.platform.toLowerCase().includes(search) ||
        p.region.toLowerCase().includes(search) ||
        (p.note && p.note.toLowerCase().includes(search))
      );
    }

    if (filterPlatform) posts = posts.filter(p => p.platform === filterPlatform);
    if (filterRegion) posts = posts.filter(p => p.region === filterRegion);

    document.getElementById("count").innerHTML = 
      `<span class="pulse-dot inline-block w-2 h-2 bg-green-500 rounded-full"></span> ${posts.length} players looking right now`;

    const listingsEl = document.getElementById("listings");
    
    if (posts.length === 0) {
      listingsEl.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">üì≠ No players found. Be the first to post!</div>';
      return;
    }

    listingsEl.innerHTML = posts
      .sort((a,b) => b.time - a.time)
      .map(p => `
        <div class="card bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700">
          <div class="flex justify-between items-start mb-3">
            <div class="font-bold text-xl text-red-400">${p.name}</div>
            <div class="time-badge text-gray-400">‚è±Ô∏è ${timeAgo(p.time)}</div>
          </div>
          <div class="text-sm my-3 flex flex-wrap gap-2">
            <span class="bg-slate-700 px-3 py-1 rounded-full">üéÆ ${p.platform}</span>
            <span class="bg-slate-700 px-3 py-1 rounded-full">üåç ${p.region}</span>
            <span class="bg-slate-700 px-3 py-1 rounded-full">üé§ ${p.mic}</span>
          </div>
          ${p.note ? `<div class="text-sm text-gray-400 mb-4 italic">"${p.note}"</div>` : ''}
          <a href="${p.discord.startsWith('http') ? p.discord : '#'}" 
             ${p.discord.startsWith('http') ? 'target="_blank" rel="noopener noreferrer"' : `onclick="window.showDiscordTag('${p.discord}'); return false;"`}
             class="block text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-all">
             ${p.discord.startsWith('http') ? 'üí¨ JOIN DISCORD' : 'üí¨ ' + p.discord}
          </a>
        </div>
      `).join("");
  }

  document.getElementById("search").addEventListener('input', () => {
    if (db) onValue(postsRef, (snapshot) => renderPosts(snapshot.val()), { onlyOnce: true });
  });
  
  document.getElementById("filterPlatform").addEventListener('change', () => {
    if (db) onValue(postsRef, (snapshot) => renderPosts(snapshot.val()), { onlyOnce: true });
  });
  
  document.getElementById("filterRegion").addEventListener('change', () => {
    if (db) onValue(postsRef, (snapshot) => renderPosts(snapshot.val()), { onlyOnce: true });
  });

  // Expose showToast globally for inline handlers
  window.showToast = showToast;
  window.showDiscordTag = (tag) => showToast(`Discord: ${tag}`);
</script>

<footer class="text-center mt-20 text-gray-600 text-sm">
  Hosted on GitHub Pages ‚Ä¢ Powered by Firebase ‚Ä¢ Made for RedSec players ‚ù§Ô∏è
</footer>
</body>
</html>
