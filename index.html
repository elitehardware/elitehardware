<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RedSec LFG - Find Squad Fast</title>
  <link href="https://unpkg.com/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: #0f172a; color: #e2e8f0; font-family: system-ui; }
    .card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgb(239 68 68 / 0.3); }
    .toast { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      padding: 16px 24px; 
      background: #10b981; 
      color: white; 
      border-radius: 8px; 
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .pulse-dot {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .skeleton {
      background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
      background-size: 200% 100%;
      animation: loading 1.5s ease-in-out infinite;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .time-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      opacity: 0.8;
    }
    .db-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    .db-status.connecting {
      background: #f59e0b;
      color: white;
    }
    .db-status.connected {
      background: #10b981;
      color: white;
    }
    .db-status.error {
      background: #ef4444;
      color: white;
    }
    .admin-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(15, 23, 42, 0.95);
      border: 2px solid #ef4444;
      border-radius: 12px;
      padding: 16px;
      min-width: 200px;
      z-index: 1000;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .admin-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      transition: all 0.3s ease;
    }
    .admin-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.6);
    }
    .delete-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }
    .delete-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body class="min-h-screen py-8 px-4">
  <!-- Database Status Badge -->
  <div class="db-status connecting" id="dbStatus">
    <span class="pulse-dot inline-block w-2 h-2 bg-white rounded-full"></span>
    <span>Connecting to database...</span>
  </div>

  <!-- Admin Toggle Button -->
  <button class="admin-toggle" id="adminToggle" title="Admin Panel">üîí</button>

  <!-- Admin Panel -->
  <div class="admin-panel" id="adminPanel" style="display: none;">
    <h3 class="text-lg font-bold text-red-500 mb-3 flex items-center gap-2">
      üõ°Ô∏è Admin Panel
    </h3>
    <div class="space-y-2 text-sm">
      <div class="flex items-center justify-between bg-slate-800 p-2 rounded">
        <span>Total Posts:</span>
        <span class="font-bold text-green-400" id="adminTotalPosts">0</span>
      </div>
      <div class="flex items-center justify-between bg-slate-800 p-2 rounded">
        <span>Active Now:</span>
        <span class="font-bold text-blue-400" id="adminActivePosts">0</span>
      </div>
      <button onclick="window.clearAllPosts()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded mt-3 transition-all">
        üóëÔ∏è Clear All Posts
      </button>
      <button onclick="window.toggleAdminMode()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded transition-all">
        ‚úèÔ∏è Toggle Delete Mode
      </button>
      <div class="text-xs text-gray-500 mt-2 pt-2 border-t border-slate-700">
        Delete mode: <span id="adminModeStatus" class="font-bold text-red-400">OFF</span>
      </div>
    </div>
  </div>

  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl md:text-5xl font-bold text-center mb-2 text-red-500">RedSec LFG</h1>
    <p class="text-center text-lg mb-8">Find a squad in seconds ‚Ä¢ No Discord required</p>

    <!-- Post Form -->
    <div class="bg-slate-800 rounded-xl p-6 mb-10 shadow-xl">
      <h2 class="text-2xl font-bold mb-4">Post LFG</h2>
      <form id="lfgForm" class="grid md:grid-cols-3 gap-4">
        <input 
          required 
          placeholder="Username / Gamertag" 
          class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" 
          id="name"
          maxlength="30"
          autocomplete="off"
        />
        <input 
          required 
          placeholder="Discord link or tag" 
          class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" 
          id="discord"
          autocomplete="off"
        />
        <select required class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" id="platform">
          <option value="" disabled selected>Platform</option>
          <option>PC</option><option>PlayStation</option><option>Xbox</option><option>Mobile</option><option>Cross-Platform</option>
        </select>
        <select required class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" id="region">
          <option value="" disabled selected>Region</option>
          <option>NA East</option><option>NA West</option><option>EU</option><option>Asia</option><option>OCE</option><option>SA</option>
        </select>
        <select required class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" id="mic">
          <option value="" disabled selected>Mic?</option>
          <option>Yes</option><option>No</option><option>Optional</option>
        </select>
        <input 
          placeholder="Note (optional)" 
          class="px-4 py-3 bg-slate-900 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" 
          id="note"
          maxlength="50"
          autocomplete="off"
        />
        <button type="submit" id="submitBtn" class="md:col-span-3 bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg text-xl transition-all">
          üöÄ POST LFG (expires in 2 hours)
        </button>
      </form>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-3 mb-8 justify-center">
      <input id="search" placeholder="üîç Search anything‚Ä¶" class="px-4 py-2 bg-slate-800 rounded-lg flex-1 min-w-[200px] focus:ring-2 focus:ring-red-500 outline-none"/>
      <select id="filterPlatform" class="px-4 py-2 bg-slate-800 rounded-lg focus:ring-2 focus:ring-red-500 outline-none">
        <option value="">All Platforms</option>
        <option>PC</option><option>PlayStation</option><option>Xbox</option><option>Mobile</option><option>Cross-Platform</option>
      </select>
      <select id="filterRegion" class="px-4 py-2 bg-slate-800 rounded-lg focus:ring-2 focus:ring-red-500 outline-none">
        <option value="">All Regions</option>
        <option>NA East</option><option>NA West</option><option>EU</option><option>Asia</option><option>OCE</option><option>SA</option>
      </select>
      <button onclick="location.reload()" class="px-6 py-2 bg-slate-700 rounded-lg hover:bg-slate-600 transition-all">Clear</button>
    </div>

    <!-- Live Listings -->
    <div id="listings" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="skeleton rounded-xl h-64"></div>
      <div class="skeleton rounded-xl h-64"></div>
      <div class="skeleton rounded-xl h-64"></div>
    </div>
    <p class="text-center mt-10 text-gray-500 flex items-center justify-center gap-2" id="count">
      <span class="pulse-dot inline-block w-2 h-2 bg-green-500 rounded-full"></span>
      Connecting to database...
    </p>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getDatabase, ref, push, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDRi-OXdRhqhmuBKlEtYgDMqwqab2mZf-c",
    authDomain: "redsec-lfg.firebaseapp.com",
    databaseURL: "https://redsec-lfg-default-rtdb.firebaseio.com", // Added the database URL
    projectId: "redsec-lfg",
    storageBucket: "redsec-lfg.firebasestorage.app",
    messagingSenderId: "969373318708",
    appId: "1:969373318708:web:c5a61792dc27d30a441461",
    measurementId: "G-HXNKL7195D"
  };

  let db, postsRef;
  const RATE_LIMIT_KEY = 'redsec_last_post';
  const RATE_LIMIT_MS = 30000;
  const ADMIN_PASSWORD = 'redsec2025'; // Change this to your secure password
  let isAdminMode = false;
  let isAdminAuthenticated = false;
  let allPostsData = null;

  // Update database status indicator
  function updateDBStatus(status, message) {
    const statusEl = document.getElementById('dbStatus');
    statusEl.className = `db-status ${status}`;
    
    const icon = status === 'connected' ? '‚úì' : status === 'error' ? '‚úó' : '‚ü≥';
    const pulseClass = status === 'connecting' ? 'pulse-dot inline-block w-2 h-2 bg-white rounded-full' : 'inline-block w-2 h-2 bg-white rounded-full';
    
    statusEl.innerHTML = `
      <span class="${pulseClass}">${status === 'connected' || status === 'error' ? '' : ''}</span>
      <span>${icon} ${message}</span>
    `;

    // Auto-hide success message after 3 seconds
    if (status === 'connected') {
      setTimeout(() => {
        statusEl.style.opacity = '0.7';
        statusEl.style.transform = 'scale(0.9)';
      }, 3000);
    }
  }

  // Initialize Firebase
  try {
    updateDBStatus('connecting', 'Connecting to database...');
    
    const app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    postsRef = ref(db, 'lfg-posts');
    
    console.log("‚úÖ Firebase initialized");
    
    // Listen for real-time updates
    onValue(postsRef, (snapshot) => {
      updateDBStatus('connected', 'Connected ‚Ä¢ Live updates enabled');
      allPostsData = snapshot.val();
      renderPosts(allPostsData);
      updateAdminStats(allPostsData);
    }, (error) => {
      console.error("Database read failed:", error);
      updateDBStatus('error', 'Connection failed');
      showToast("Failed to load posts. Check Firebase setup.", "error");
      document.getElementById("count").innerHTML = 
        `<span class="inline-block w-2 h-2 bg-red-500 rounded-full"></span> Database error - check console`;
    });
    
    // Clean expired posts every minute
    setInterval(cleanExpiredPosts, 60000);
    
  } catch (err) {
    console.error("Firebase init failed:", err);
    updateDBStatus('error', 'Connection failed');
    showToast("Failed to connect to Firebase", "error");
    document.getElementById("listings").innerHTML = `
      <div class="col-span-full bg-red-900/20 border border-red-500 rounded-xl p-8 text-center">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h3 class="text-2xl font-bold mb-2">Database Connection Failed</h3>
        <p class="text-gray-400 mb-4">Make sure you've created a Realtime Database in Firebase Console:</p>
        <ol class="text-left inline-block text-gray-400 mb-4 space-y-2">
          <li>1. Go to Firebase Console ‚Üí Realtime Database</li>
          <li>2. Click "Create Database"</li>
          <li>3. Choose a location (us-central1 recommended)</li>
          <li>4. Start in "Test mode" for now</li>
        </ol>
        <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold">
          üîÑ Retry Connection
        </button>
      </div>
    `;
  }

  function showToast(message, type = 'success') {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.style.background = type === 'error' ? '#ef4444' : '#10b981';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function sanitize(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function validateDiscord(input) {
    const discordLinkPattern = /discord\.(gg|com\/invite)\//i;
    const discordTagPattern = /^.{2,32}#\d{4}$|^@?[a-z0-9_.]{2,32}$/i;
    return discordLinkPattern.test(input) || discordTagPattern.test(input);
  }

  function canPost() {
    const lastPost = localStorage.getItem(RATE_LIMIT_KEY);
    if (lastPost) {
      const timeSince = Date.now() - parseInt(lastPost);
      if (timeSince < RATE_LIMIT_MS) {
        const remaining = Math.ceil((RATE_LIMIT_MS - timeSince) / 1000);
        showToast(`Please wait ${remaining}s before posting again`, 'error');
        return false;
      }
    }
    return true;
  }

  function timeAgo(timestamp) {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return 'Just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    return `${hours}h ago`;
  }

  document.getElementById("lfgForm").onsubmit = async (e) => {
    e.preventDefault();
    
    if (!db) {
      showToast("Database not ready. Please refresh.", 'error');
      return;
    }

    if (!canPost()) return;

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Posting...';

    const discordInput = e.target.discord.value.trim();
    
    if (!validateDiscord(discordInput)) {
      showToast("Please enter a valid Discord link or tag", 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'üöÄ POST LFG (expires in 2 hours)';
      return;
    }

    try {
      const data = {
        name: sanitize(e.target.name.value.trim()),
        discord: sanitize(discordInput),
        platform: e.target.platform.value,
        region: e.target.region.value,
        mic: e.target.mic.value,
        note: sanitize(e.target.note.value.trim() || ''),
        time: Date.now(),
        expires: Date.now() + 2*60*60*1000
      };
      
      await push(postsRef, data);
      localStorage.setItem(RATE_LIMIT_KEY, Date.now().toString());
      e.target.reset();
      showToast("‚úÖ Posted! Your LFG is now live!");
    } catch (err) {
      console.error("Post failed:", err);
      showToast("Failed to post. Please try again.", 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'üöÄ POST LFG (expires in 2 hours)';
    }
  };

  async function cleanExpiredPosts() {
    if (!db) return;
    
    onValue(postsRef, (snap) => {
      const posts = snap.val();
      if (!posts) return;
      
      Object.entries(posts).forEach(([key, post]) => {
        if (post.expires < Date.now()) {
          remove(ref(db, `lfg-posts/${key}`));
        }
      });
    }, { onlyOnce: true });
  }

  function renderPosts(postsData) {
    let posts = [];
    
    if (postsData) {
      posts = Object.entries(postsData)
        .map(([key, post]) => ({ ...post, id: key }))
        .filter(p => p.expires > Date.now() && p.name && p.discord);
    }

    const search = document.getElementById("search").value.toLowerCase();
    const filterPlatform = document.getElementById("filterPlatform").value;
    const filterRegion = document.getElementById("filterRegion").value;

    if (search) {
      posts = posts.filter(p => 
        p.name.toLowerCase().includes(search) ||
        p.discord.toLowerCase().includes(search) ||
        p.platform.toLowerCase().includes(search) ||
        p.region.toLowerCase().includes(search) ||
        (p.note && p.note.toLowerCase().includes(search))
      );
    }

    if (filterPlatform) posts = posts.filter(p => p.platform === filterPlatform);
    if (filterRegion) posts = posts.filter(p => p.region === filterRegion);

    document.getElementById("count").innerHTML = 
      `<span class="pulse-dot inline-block w-2 h-2 bg-green-500 rounded-full"></span> ${posts.length} players looking right now`;

    const listingsEl = document.getElementById("listings");
    
    if (posts.length === 0) {
      listingsEl.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">üì≠ No players found. Be the first to post!</div>';
      return;
    }

    listingsEl.innerHTML = posts
      .sort((a,b) => b.time - a.time)
      .map(p => `
        <div class="card bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700">
          <div class="flex justify-between items-start mb-3">
            <div class="font-bold text-xl text-red-400">${p.name}</div>
            <div class="flex items-center gap-2">
              <div class="time-badge text-gray-400">‚è±Ô∏è ${timeAgo(p.time)}</div>
              ${isAdminMode ? `<button onclick="window.deletePost('${p.id}', '${p.name.replace(/'/g, "\\'")}', event)" class="delete-btn">üóëÔ∏è</button>` : ''}
            </div>
          </div>
          <div class="text-sm my-3 flex flex-wrap gap-2">
            <span class="bg-slate-700 px-3 py-1 rounded-full">üéÆ ${p.platform}</span>
            <span class="bg-slate-700 px-3 py-1 rounded-full">üåç ${p.region}</span>
            <span class="bg-slate-700 px-3 py-1 rounded-full">üé§ ${p.mic}</span>
          </div>
          ${p.note ? `<div class="text-sm text-gray-400 mb-4 italic">"${p.note}"</div>` : ''}
          <a href="${p.discord.startsWith('http') ? p.discord : '#'}" 
             ${p.discord.startsWith('http') ? 'target="_blank" rel="noopener noreferrer"' : `onclick="window.showDiscordTag('${p.discord}'); return false;"`}
             class="block text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-all">
             ${p.discord.startsWith('http') ? 'üí¨ JOIN DISCORD' : 'üí¨ ' + p.discord}
          </a>
          ${p.discord.startsWith('http') ? `
          <button onclick="window.copyDiscord('${p.discord.replace(/'/g, "\\'")}', event)" 
                  class="mt-2 w-full text-sm text-gray-400 hover:text-white transition-colors">
            üìã Copy invite
          </button>
          ` : ''}
        </div>
      `).join("");
  }

  document.getElementById("search").addEventListener('input', () => {
    if (db) renderPosts(allPostsData);
  });
  
  document.getElementById("filterPlatform").addEventListener('change', () => {
    if (db) renderPosts(allPostsData);
  });
  
  document.getElementById("filterRegion").addEventListener('change', () => {
    if (db) renderPosts(allPostsData);
  });

  // Expose functions globally for inline handlers
  window.showToast = showToast;
  window.showDiscordTag = (tag) => showToast(`Discord: ${tag}`);
  window.copyDiscord = (text, event) => {
    event?.preventDefault();
    event?.stopPropagation();
    navigator.clipboard.writeText(text).then(() => {
      showToast("‚úÖ Copied to clipboard!");
    }).catch(() => {
      showToast("Failed to copy", "error");
    });
  };
</script>

<footer class="text-center mt-20 text-gray-600 text-sm">
  Hosted on GitHub Pages ‚Ä¢ Powered by Firebase ‚Ä¢ Made for RedSec players ‚ù§Ô∏è
</footer>
</body>
</html>
